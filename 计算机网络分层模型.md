对于同一台设备上的进程间通信，有很多种方式，比如：管道、消息队列、共享内存、信号等方式，

而对于不同设备上的进程间通信，就需要网络通信，那么就需要双方遵守同样的规则，

网络通信可能会经过很多网络设备（例如：集线器、交换机、路由器），所以要兼容多种多样的设备，就需要一套通用的网络协议。



这个网络协议是分层的，每一层都有各自的作用和职责，接下来就分别对每一层进行介绍。

![img](https://cdn.jsdelivr.net/gh/xiaolincoder/ImageHost/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E9%94%AE%E5%85%A5%E7%BD%91%E5%9D%80%E8%BF%87%E7%A8%8B/12.jpg)

# 应用层

应用层为应用程序提供网络服务。

应用层工作在操作系统的用户态。

传输层和网络层的协议内容由操作系统内核实现，工作在操作系统的内核态。

数据链路层和物理层由网卡的驱动程序实现。



常见的应用层协议有：HTTP、HTTPS、DNS、SSH、Telnet、FTP、DHCP

- HTTP：超文本传输协议（TCP）
- DNS：域名解析协议（UDP / TCP）
- SSH：安全外壳协议（TCP）， 专为远程登录会话和其他网络服务提供安全性
- Telnet：远程登录协议（TCP）
- FTP：文件传输协议（TCP）
- DHCP：动态主机配置协议（UDP）

域名解析协议使用的传输层协议可能是 UDP，也可能是 TCP。

当客户端发出 DNS 查询请求时，从服务器收到的响应报文中的 TC（删减标志）比特被置为 1 时，表示应答总长度超过 512 字节，只返回前 512 个字节，这时 DNS 就需要使用 TCP 重发原来的查询请求。

# 传输层

应用层的数据包会传给传输层，传输层提供两台计算机之间的数据传输。

发送方的传输层会在数据包首部加上源端口号、目的端口号。端口号用以区分同一台计算机的不同进程。

因此接收方可以识别出该数据包是发送给哪个应用进程的。



TCP 和 UDP（传输层控制协议、用户数据报协议）是传输层的两个协议。

TCP 是面向连接的、可靠的、基于字节流的传输层控制协议。

UDP 是无连接的、不可靠的、基于数据报的用户数据报协议。

> 面向连接就是指：使用 TCP 协议进行通信前，需要先建立 TCP 连接，约定状态信息（Socket、序列号、窗口大小），产生一个 Socket 结构。
>
> Socket 结构里有两个重要的队列：一个发送队列、一个是接收队列。
>
> 可能内核程序处理网络包的速度比接收网络包的速度满，因此接收的网络包都先缓存在队列里，处理完一个网络包再从接收队列里取下一个。
>
> 发送队列也同理。
>
> 
>
> UDP 是无连接的，即没有维护状态信息的，因而不需要每对连接建立一组 Socket，
>
> 而是只要有一个 Socket，就能够和多个客户端通信。

------

**TCP 的可靠 & UDP 的不可靠**

我们先来看 UDP 提供的功能：应用让 UDP 发送数据包，UDP 就会发送数据包，

UDP 把数据包发送出去之后，就不会管接收方是否成功收到了该数据包，因此使用 UDP 协议会存在：「接收方没有收到该数据包的问题，即数据包丢失的问题」 和 「因分片数据丢失，所有接收方丢弃整个 UDP 数据包的问题」。

简而言之：UDP 存在数据包丢失问题 和 分片数据丢失造成整个 UDP 数据包被丢弃的问题。

> 如果 IP 数据报的长度 > MTU（最大传输单元，为 1500 字节），那么发送方的网络层就需要对 IP 数据报进行分片，使每一片都 < MTU，
>
> 由于中间的路由器也有可能对 IP 数据报进行分片，因为不同网络的 MTU 是不一样的。
>
> 而接收方的网络层需要进行 IP 数据报的重组，如果分片数据丢失，接收方无法完成 IP 数据报的重组，接收方便会丢弃整个 UDP 数据包。
>
> 并且分片数据的重组只会发生在目的端的网络层。



数据包丢失、分片数据丢失可能是发送方的问题，可能是传输过程中的网络设备（路由器）的问题，也可能是接收方的问题

- 发送方丢包：发送方的网卡处理不过来，网卡的输出队列满了，那么网卡就会把数据包丢弃
- 路由器丢包：数据包在网络设备上转发时，某台设备的缓冲队列满了，那么该设备也会把该数据报丢弃（拥塞控制）
- 接收方丢包：接收方处理数据较慢，导致接收缓冲区满了，那么接收方也会把该数据报丢弃（流量控制）



TCP 使用「滑动窗口机制」实现流量控制，避免因接收方的接收缓冲区满了造成的丢包。

TCP 使用「拥塞窗口机制」实现拥塞控制，避免路由器的缓冲队列过长、满了造成的超时、丢包。

如果还是发生了超时、丢包，那么 TCP 的超时重传机制会保证接收方能够收到数据包。

# 网络层

TCP 基于字节流、UDP 基于数据报、建立连接的三次握手、断开连接的四次挥手、滑动窗口机制、拥塞窗口机制、以及网络层以下

# 数据链路层



# 物理层

